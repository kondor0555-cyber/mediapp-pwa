<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediReminder</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8E0B5B">

  <style>
    :root{
      --fuchsia-dark:#8E0B5B;
      --fuchsia-card:#C14D8C;
      --fuchsia-accent:#FF4FB6;
      --text:#ffffff;
      --text-dim: rgba(255,255,255,0.85);
      --overlay: rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(160deg, #7a084f, var(--fuchsia-dark)); color:var(--text);
      display:flex; flex-direction:column; height:100%;
    }
    header{background:var(--fuchsia-dark);padding:14px 20px;font-weight:bold;font-size:20px;text-align:center;color:white;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    main{flex:1; display:flex; align-items:flex-start; justify-content:center; padding:20px; overflow:auto}
    .app{width:min(980px,100%); position:relative; padding-bottom:90px}
    .nav{display:flex; justify-content:space-around; margin-bottom:20px; gap:6px;}
    .nav button{flex:1; margin:0 2px; padding:12px; border:none; border-radius:16px; cursor:pointer;font-weight:600; background:var(--fuchsia-accent); color:#220013; box-shadow:0 4px 12px rgba(0,0,0,.25);}
    .card{background:var(--fuchsia-card);border-radius:24px; padding:32px;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);min-height:460px;}
    h2{margin:0 0 12px 0; font-size:22px}
    p.lead{margin:0 0 18px 0; color:var(--text-dim)}
    .row{display:flex; flex-wrap:wrap; gap:12px}
    .field{flex:1 1 220px; display:flex; flex-direction:column; gap:6px}
    label{font-size:13px; color:var(--text-dim)}
    input[type="text"], input[type="time"], input[type="number"], input[type="datetime-local"], select{
      appearance:none; border:none; outline:none; border-radius:14px; padding:12px 14px; font-size:15px;
      background:rgba(0,0,0,.2); color:var(--text);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.15);
    }
    button.primary{
      appearance:none; border:none; border-radius:16px; padding:12px 16px; font-weight:600; font-size:15px;
      background:var(--fuchsia-accent); color:#220013; cursor:pointer; transition:filter .15s ease;
      box-shadow:0 6px 18px rgba(255,79,182,.35);
    }
    .list{margin-top:20px; display:grid; gap:12px}
    .item{background:rgba(0,0,0,.22); border-radius:16px; padding:14px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .actions{display:flex; gap:8px}
    .btn{background:transparent; border:1px solid rgba(255,255,255,.25); color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.12)}
    .title{font-weight:700}
    .sub{font-size:13px; color:var(--text-dim)}
    .submenu{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .submenu button{flex:1 1 120px; background:rgba(255,255,255,.2); border:none; border-radius:12px; padding:10px; color:var(--text); cursor:pointer}
    .measure-form{margin-top:16px}
    .print-bar{margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .lang-toggle{position:absolute; left:0; right:0; bottom:0; display:flex; justify-content:center; flex-wrap:wrap;padding:16px 8px; gap:12px;background:rgba(0,0,0,0.2); border-radius:20px; margin:0 10px;}
    .lang-toggle-inner{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }
    .lang-toggle-inner > div:first-child{
      display:flex;
      gap:6px;
    }
    .lang-toggle button{border:none; border-radius:999px; padding:8px 14px; background:rgba(255,255,255,.2); color:#fff; cursor:pointer; font-size:12px;}
    .collapse-toggle{background:rgba(255,255,255,.2); border:none; border-radius:12px; padding:8px 12px; color:#fff; cursor:pointer;font-weight:600}
    .collapsible-extra{display:none}
    .modal-backdrop{position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:9999;}
    .modal{width:min(520px,90%); background:#2b0e20; color:#fff; border:1px solid rgba(255,255,255,.2);border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.5);}
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:0 0 16px 0; color:var(--text-dim)}
    .modal .actions{justify-content:flex-end; gap:8px}
    .action-row{
      flex: 1 1 100%;
      display:flex;
      justify-content:flex-end;
      align-items:flex-end;
      gap: 8px;
    }

    /* SPLASH SCREEN */
    .splash{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top, #ff7ac8, #5a0438 60%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      transition:opacity .6s ease;
    }
    .splash.hidden{
      opacity:0;
      pointer-events:none;
    }
    .splash-inner{
      text-align:center;
    }
    .splash-logo{
      width:120px;
      height:120px;
      border-radius:40px;
      background:rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 18px;
      box-shadow:0 18px 40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.18);
      position:relative;
    }
    .splash-logo::before,
    .splash-logo::after{
      content:'';
      position:absolute;
      background:#fff;
      border-radius:4px;
    }
    .splash-logo::before{
      width:12px; height:60px;
    }
    .splash-logo::after{
      width:60px; height:12px;
    }
    .splash-title{
      font-size:28px;
      font-weight:800;
      letter-spacing:1px;
      text-shadow:0 4px 18px rgba(0,0,0,.6);
    }
    .splash-sub{
      margin-top:6px;
      font-size:13px;
      color:var(--text-dim);
    }
  </style>
</head>
<body>
  <!-- SPLASH OVERLAY -->
  <div id="splash" class="splash">
    <div class="splash-inner">
      <div class="splash-logo"></div>
      <div class="splash-title">MediReminder</div>
      <div class="splash-sub">Your health, simplified</div>
    </div>
  </div>

  <header>MediReminder</header>
  <main>
    <div class="app">
      <!-- Tabs -->
      <div class="nav">
        <button id="tab-meds" onclick="showSection('meds')">Î¦Î¬ÏÎ¼Î±ÎºÎ±</button>
        <button id="tab-appts" onclick="showSection('appts')">Î¡Î±Î½Ï„ÎµÎ²Î¿Ï</button>
        <button id="tab-measure" onclick="showSection('measure')">ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</button>
        <button id="tab-prints" onclick="showSection('prints')">Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚</button>
      </div>

      <!-- Î¦Î¬ÏÎ¼Î±ÎºÎ± -->
      <div id="section-meds" class="card section">
        <h2 id="meds-title">Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î¦Î±ÏÎ¼Î¬ÎºÎ¿Ï…</h2>
        <p class="lead" id="meds-lead">Î’Î¬Î»Îµ Î­Î½Î± Ï†Î¬ÏÎ¼Î±ÎºÎ¿ ÎºÎ±Î¹ ÏÏÎ± Ï…Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·Ï‚.</p>
        <div class="row">
          <div class="field">
            <label id="label-med-name">ÎŒÎ½Î¿Î¼Î± Ï†Î±ÏÎ¼Î¬ÎºÎ¿Ï…</label>
            <input id="med-name" type="text" />
          </div>
          <div class="field">
            <label id="label-med-time">ÎÏÎ±</label>
            <input id="med-time" type="time" />
          </div>
          <div class="field">
            <label id="label-med-note">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</label>
            <select id="med-note"></select>
            <input id="med-note-custom" type="text" placeholder="Î†Î»Î»Î¿â€¦" style="display:none; margin-top:6px" />
          </div>
          <div class="action-row">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="med-daily" /> <span id="label-med-daily">ÎšÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î¬</span></label>
            <button class="primary" id="btn-add-meds" onclick="addReminder('meds')">+ Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ</button>
          </div>
        </div>
        <div class="list" id="list-meds"></div>
      </div>

      <!-- Î¡Î±Î½Ï„ÎµÎ²Î¿Ï -->
      <div id="section-appts" class="card section" style="display:none">
        <h2 id="appts-title">Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î¡Î±Î½Ï„ÎµÎ²Î¿Ï</h2>
        <p class="lead" id="appts-lead">Î’Î¬Î»Îµ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï Î¼Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎºÎ±Î¹ ÏÏÎ± (Î¸Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯Ï‚ 3 ÏÏÎµÏ‚ Î½Ï‰ÏÎ¯Ï„ÎµÏÎ±).</p>
        <div class="row">
          <div class="field">
            <label id="label-appt-name">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÏÎ±Î½Ï„ÎµÎ²Î¿Ï</label>
            <input id="appt-name" type="text" />
          </div>
          <div class="field">
            <label id="label-appt-datetime">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± & ÎÏÎ±</label>
            <input id="appt-datetime" type="datetime-local" />
          </div>
          <div class="action-row">
            <button class="primary" id="btn-add-appt" onclick="addReminder('appts')">+ Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ</button>
          </div>
        </div>
        <div class="list" id="list-appts"></div>
      </div>

      <!-- ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚ -->
      <div id="section-measure" class="card section" style="display:none">
        <h2 id="measure-title-main">ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</h2>
        <p class="lead" id="measure-lead">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎºÎ±Î¹ Î²Î¬Î»Îµ Ï„Î¹Ï‚ ÎºÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î­Ï‚ Ï„Î¹Î¼Î­Ï‚ ÏƒÎ¿Ï….</p>

        <div class="submenu">
          <button id="btn-heart" onclick="openMeasure('heart')">Î Î±Î»Î¼Î¿Î¯</button>
          <button id="btn-sugar" onclick="openMeasure('sugar')">Î–Î¬ÎºÏ‡Î±ÏÎ¿</button>
          <button id="btn-pressure" onclick="openMeasure('pressure')">Î Î¯ÎµÏƒÎ·</button>
          <button id="btn-chol" onclick="openMeasure('chol')">ÎŸÎ¾Ï…Î³ÏŒÎ½Î¿</button>
        </div>

        <div class="measure-form" id="measure-form" style="display:none">
          <h3 id="measure-title"></h3>
          <div class="row">
            <div class="field">
              <label id="label-measure-value">Î¤Î¹Î¼Î®</label>
              <input id="measure-value" />
              <small id="measure-hint" style="opacity:.85"></small>
            </div>
            <div class="field">
              <label id="label-measure-note">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</label>
              <select id="measure-note"></select>
              <input id="measure-note-custom" type="text" placeholder="Î†Î»Î»Î¿â€¦" style="display:none; margin-top:6px" />
            </div>
            <div class="action-row">
              <button class="primary" id="btn-save-measure" onclick="saveMeasure()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            </div>
          </div>
        </div>

        <!-- Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚ (Î³ÏÎ®Î³Î¿ÏÎ· ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·) -->
        <div class="print-bar">
          <label id="label-print" for="print-select" style="font-size:13px; color:var(--text-dim); margin-right:6px">Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚</label>
          <select id="print-select" aria-labelledby="label-print"></select>
          <button class="primary" id="btn-print" onclick="printSelected()">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
        </div>

        <div class="list" id="measure-list"></div>
      </div>

      <!-- ÎšÎ±ÏÏ„Î­Î»Î± Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚ -->
      <div id="section-prints" class="card section" style="display:none">
        <h2 id="prints-title">Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚</h2>
        <p class="lead" id="prints-lead">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î¼ÎµÏ„ÏÎ®ÏƒÎµÏ‰Î½ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ· ÏƒÎµ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î® ÏƒÎµÎ»Î¯Î´Î±.</p>

        <div class="print-bar">
          <label id="label-print2" for="print-select2" style="font-size:13px; color:var(--text-dim); margin-right:6px">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
          <select id="print-select2" aria-labelledby="label-print2"></select>
          <button class="primary" id="btn-print2" onclick="printSelectedFrom('print-select2')">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
        </div>
      </div>

      <!-- Î“Î»ÏÏƒÏƒÎ± + ÎºÎ¿Ï…Î¼Ï€Î¯ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ -->
      <div class="lang-toggle">
        <div class="lang-toggle-inner">
          <div>
            <button onclick="setLang('el')">Î•Î»Î»Î·Î½Î¹ÎºÎ¬</button>
            <button onclick="setLang('en')">English</button>
          </div>
          <button onclick="requestNotificationPermission()">ğŸ”” Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <h3 id="modal-title">Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·</h3>
      <p id="modal-message"></p>
      <div class="actions">
        <button class="primary" id="modal-snooze">Î‘Î½Î±Î²Î¿Î»Î® 5â€™</button>
        <button class="primary" id="modal-skip">Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ·</button>
        <button class="primary" id="modal-ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Service worker (PWA / offline)
    if ('serviceWorker' in navigator && String(location.protocol).indexOf('http')===0) {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }

    // ===== Notifications (PWA / system) =====
    async function requestNotificationPermission(){
      if (!('Notification' in window)) {
        alert('ÎŸ browser Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚.');
        return;
      }

      if (Notification.permission === 'granted') {
        alert(currentLang === 'el'
          ? 'ÎŸÎ¹ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³Î­Ï‚.'
          : 'Notifications are already enabled.');
        return;
      }

      const res = await Notification.requestPermission();
      if (res === 'granted') {
        alert(currentLang === 'el'
          ? 'ÎŸÎ¹ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎ±Î½.'
          : 'Notifications enabled.');
      } else {
        alert(currentLang === 'el'
          ? 'Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Î¬Î´ÎµÎ¹Î± Î³Î¹Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚.'
          : 'Notification permission was not granted.');
      }
    }

    async function showNativeNotification(title, body){
      try{
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') return;

        const reg = await navigator.serviceWorker.getRegistration();
        const options = {
          body,
          icon: 'icons/icon-192.png',
          badge: 'icons/icon-72.png',
          vibrate: [200,200],
          tag: 'mediapp-'+Date.now(),
          data: { url: './' }
        };

        if (reg && reg.showNotification) {
          reg.showNotification(title, options);
        } else {
          new Notification(title, options);
        }
      }catch(e){
        console.error('Notification error', e);
      }
    }

    // ===== i18n =====
    const i18n = {
      el: {
        common:{ del:'Î”Î¹Î±Î³ÏÎ±Ï†Î®', confirmDel:'Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯;', more:'Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ±', less:'Î›Î¹Î³ÏŒÏ„ÎµÏÎ±', pleaseFill:'Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ: ' },
        tabs: { meds: 'Î¦Î¬ÏÎ¼Î±ÎºÎ±', appts: 'Î¡Î±Î½Ï„ÎµÎ²Î¿Ï', measure: 'ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚', prints:'Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚' },
        meds: {
          title: 'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î¦Î±ÏÎ¼Î¬ÎºÎ¿Ï…',
          lead: 'Î’Î¬Î»Îµ Î­Î½Î± Ï†Î¬ÏÎ¼Î±ÎºÎ¿ ÎºÎ±Î¹ ÏÏÎ± Ï…Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·Ï‚.',
          name: 'ÎŒÎ½Î¿Î¼Î± Ï†Î±ÏÎ¼Î¬ÎºÎ¿Ï…', time: 'ÎÏÎ±', daily: 'ÎšÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î¬', add: '+ Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ',
          noteLabel:'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·',
          noteOptions:['â€”','Î ÏÎ¹Î½ Ï„Î¿ Ï†Î±Î³Î·Ï„ÏŒ','ÎœÎµÏ„Î¬ Ï„Î¿ Ï†Î±Î³Î·Ï„ÏŒ','ÎœÎµ Î½ÎµÏÏŒ','Î†Î´ÎµÎ¹Î¿ ÏƒÏ„Î¿Î¼Î¬Ï‡Î¹','Î ÏÎ¹Î½ Ï„Î¿Î½ ÏÏ€Î½Î¿','Î†Î»Î»Î¿â€¦'],
          list_time: (t,d,n)=>`ÎÏÎ±: ${t} ${d?'Â· ÎšÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î¬':''}${n?` Â· Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: ${n}`:''}`
        },
        appts: {
          title: 'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î¡Î±Î½Ï„ÎµÎ²Î¿Ï',
          lead: 'Î’Î¬Î»Îµ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï Î¼Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎºÎ±Î¹ ÏÏÎ± (Î¸Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯Ï‚ 3 ÏÏÎµÏ‚ Î½Ï‰ÏÎ¯Ï„ÎµÏÎ±).',
          name: 'Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÏÎ±Î½Ï„ÎµÎ²Î¿Ï', datetime: 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± & ÎÏÎ±', add: '+ Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ',
          list_line: (dt,at)=>` Î¡Î±Î½Ï„ÎµÎ²Î¿Ï: ${dt} Â· Î•Î¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÏƒÏ„Î¹Ï‚: ${at}`
        },
        measure: {
          title: 'ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚', lead: 'Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎºÎ±Î¹ Î²Î¬Î»Îµ Ï„Î¹Ï‚ ÎºÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î­Ï‚ Ï„Î¹Î¼Î­Ï‚ ÏƒÎ¿Ï….',
          cats: { heart:'Î Î±Î»Î¼Î¿Î¯', sugar:'Î–Î¬ÎºÏ‡Î±ÏÎ¿', pressure:'Î Î¯ÎµÏƒÎ·', chol:'ÎŸÎ¾Ï…Î³ÏŒÎ½Î¿' },
          value:'Î¤Î¹Î¼Î®', save:'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·',
          entry:(date,time,val,note)=>`Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${date} Â· ÎÏÎ±: ${time} Â· Î¤Î¹Î¼Î®: ${val}${note?` Â· Î£Î·Î¼.: ${note}`:''}`,
          entryTitle:(kind)=>({heart:'Î Î±Î»Î¼Î¿Î¯',sugar:'Î–Î¬ÎºÏ‡Î±ÏÎ¿',pressure:'Î Î¯ÎµÏƒÎ·',chol:'ÎŸÎ¾Ï…Î³ÏŒÎ½Î¿'}[kind]||kind),
          pressureLabel:'Î Î¯ÎµÏƒÎ· (ÎœÎµÎ³Î¬Î»Î·-ÎœÎ¹ÎºÏÎ®)', pressureHint:'Ï€.Ï‡. 15-7 Î® 120-80',
          pulseHint:'bpm (20â€“220)', oxygenHint:'% SpOâ‚‚ (50â€“100)',
          placeholders:{ heart:'Ï€.Ï‡. 72', sugar:'Ï€.Ï‡. 110', pressure:'Ï€.Ï‡. 15-7', chol:'Ï€.Ï‡. 97' },
          noteLabel:'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·',
          noteOptions:{
            heart:['â€”','Î£Îµ Î·ÏÎµÎ¼Î¯Î±','ÎœÎµÏ„Î¬ Î±Ï€ÏŒ Ï€ÎµÏÏ€Î¬Ï„Î·Î¼Î±','ÎœÎµÏ„Î¬ Î±Ï€ÏŒ Î¬ÏƒÎºÎ·ÏƒÎ·','Î†Î»Î»Î¿â€¦'],
            sugar:['â€”','ÎÎ·ÏƒÏ„Î¹ÎºÏŒÏ‚/Î·','Î ÏÎ¹Î½ Ï„Î¿ Ï†Î±Î³Î·Ï„ÏŒ','2 ÏÏÎµÏ‚ Î¼ÎµÏ„Î¬ Ï„Î¿ Ï†Î±Î³Î·Ï„ÏŒ','Î†Î»Î»Î¿â€¦'],
            pressure:['â€”','ÎšÎ±Î¸Î¹ÏƒÏ„ÏŒÏ‚/Î®','ÎŒÏÎ¸Î¹Î¿Ï‚/Î±','Î ÏÏ‰Î¯','Î’ÏÎ¬Î´Ï…','Î†Î»Î»Î¿â€¦'],
            chol:['â€”','Î£Îµ Î·ÏÎµÎ¼Î¯Î±','ÎœÎµÏ„Î¬ Î±Ï€ÏŒ Ï€ÎµÏÏ€Î¬Ï„Î·Î¼Î±','Î†Î»Î»Î¿â€¦']
          },
          printLabel:'Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚',
          printBtn:'Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·'
        },
        prints:{
          title:'Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚',
          lead:'Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î¼ÎµÏ„ÏÎ®ÏƒÎµÏ‰Î½ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·.',
          label:'Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±',
          btn:'Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·'
        },
        modal: { reminder:'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·', appt:'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· ÏÎ±Î½Ï„ÎµÎ²Î¿Ï', ok:'OK', skip:'Î Î±ÏÎ¬Î»ÎµÎ¹ÏˆÎ·', snooze5:'Î‘Î½Î±Î²Î¿Î»Î® 5â€™' },
        errors:{
          need_time:'Î”ÏÏƒÎµ ÏÏÎ±.', need_datetime:'Î”ÏÏƒÎµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎºÎ±Î¹ ÏÏÎ±.',
          need_value:'Î”ÏÏƒÎµ Ï„Î¹Î¼Î®.', bad_pressure:'Î”ÏÏƒÎµ Ï€Î¯ÎµÏƒÎ· Î¼Î¿ÏÏ†Î®Ï‚ ÎœÎµÎ³Î¬Î»Î·-ÎœÎ¹ÎºÏÎ®, Ï€.Ï‡. 15-7',
          bad_pulse:'ÎŸÎ¹ Ï€Î±Î»Î¼Î¿Î¯ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î±ÎºÎ­ÏÎ±Î¹Î¿Ï‚ 20â€“220.',
          bad_oxygen:'Î¤Î¿ Î¿Î¾Ï…Î³ÏŒÎ½Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 50â€“100 (% SpOâ‚‚).',
          bad_text:'Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Î¹ Î³ÏÎ¬Î¼Î¼Î±Ï„Î±, Î±ÏÎ¹Î¸Î¼Î¿Î¯ ÎºÎ±Î¹ Î±Ï€Î»Î¬ ÏƒÏÎ¼Î²Î¿Î»Î±.'
        },
        untitled:'(Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î¯Ï„Î»Î¿)',
        reminder_now_title:'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·',
        appt_now_title:'Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· ÏÎ±Î½Ï„ÎµÎ²Î¿Ï'
      },
      en: {
        common:{ del:'Delete', confirmDel:'Are you sure you want to delete it?', more:'More', less:'Less', pleaseFill:'Please fill: ' },
        tabs: { meds: 'Medicines', appts: 'Appointments', measure: 'Measurements', prints:'Prints' },
        meds: {
          title: 'Medicine Reminder',
          lead: 'Enter a medicine name and a reminder time.',
          name: 'Medicine name', time: 'Time', daily: 'Daily', add: '+ Add',
          noteLabel:'Note',
          noteOptions:['â€”','Before meal','After meal','With water','Empty stomach','Before sleep','Otherâ€¦'],
          list_time: (t,d,n)=>`Time: ${t} ${d?'Â· Daily':''}${n?` Â· Note: ${n}`:''}`
        },
        appts: {
          title: 'Appointment Reminder',
          lead: 'Set an appointment date & time (you will be notified 3 hours earlier).',
          name: 'Appointment description', datetime: 'Date & Time', add: '+ Add',
          list_line: (dt,at)=>` Appointment: ${dt} Â· Reminder at: ${at}`
        },
        measure: {
          title: 'Measurements', lead: 'Choose a category and add your daily values.',
          cats: { heart:'Pulse', sugar:'Glycemia', pressure:'Blood Pressure', chol:'Oxygen' },
          value:'Value', save:'Save',
          entry:(date,time,val,note)=>`Date: ${date} Â· Time: ${time} Â· Value: ${val}${note?` Â· Note: ${note}`:''}`,
          entryTitle:(kind)=>({heart:'Pulse',sugar:'Glycemia',pressure:'Blood Pressure',chol:'Oxygen'}[kind]||kind),
          pressureLabel:'Blood Pressure (Sys-Dia)', pressureHint:'e.g. 120-80 or 15-7',
          pulseHint:'bpm (20â€“220)', oxygenHint:'% SpOâ‚‚ (50â€“100)',
          placeholders:{ heart:'e.g. 72', sugar:'e.g. 110', pressure:'e.g. 120-80', chol:'e.g. 97' },
          noteLabel:'Note',
          noteOptions:{
            heart:['â€”','At rest','After walking','After exercise','Otherâ€¦'],
            sugar:['â€”','Fasting','Before meal','2h after meal','Otherâ€¦'],
            pressure:['â€”','Sitting','Standing','Morning','Evening','Otherâ€¦'],
            chol:['â€”','At rest','After walking','Otherâ€¦']
          },
          printLabel:'Print',
          printBtn:'Print'
        },
        prints:{
          title:'Prints',
          lead:'Select a measurement category to print.',
          label:'Print by category',
          btn:'Print'
        },
        modal: { reminder:'Reminder', appt:'Appointment reminder', ok:'OK', skip:'Skip', snooze5:'Snooze 5â€™' },
        errors:{
          need_time:'Please enter a time.', need_datetime:'Please enter date & time.',
          need_value:'Please enter a value.', bad_pressure:'Enter pressure as Sys-Dia, e.g. 120-80',
          bad_pulse:'Pulse must be an integer between 20 and 220.',
          bad_oxygen:'Oxygen must be between 50 and 100 (% SpOâ‚‚).',
          bad_text:'Letters, numbers and basic symbols are allowed.'
        },
        untitled:'(untitled)',
        reminder_now_title:'Reminder',
        appt_now_title:'Appointment reminder'
      }
    };

    const STORAGE_LANG = 'medireminder-lang';
    let currentLang = localStorage.getItem(STORAGE_LANG) || (String(navigator.language||'').toLowerCase().startsWith('el')?'el':'en');
    function t(){ return i18n[currentLang]; }

    // storage
    const STORAGE_REMINDERS = 'medireminder-reminders';
    const STORAGE_MEASURES  = 'measures';
    let reminders = JSON.parse(localStorage.getItem(STORAGE_REMINDERS) || '{"meds":[],"appts":[]}');
    let measures  = JSON.parse(localStorage.getItem(STORAGE_MEASURES)   || '{}');

    function persist(){
      localStorage.setItem(STORAGE_REMINDERS, JSON.stringify(reminders));
      localStorage.setItem(STORAGE_MEASURES,  JSON.stringify(measures));
    }

    // helpers
    function todayStr(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
    function z(n){ return String(n).padStart(2,'0'); }
    function nowLocalDatetimeValue(){
      const d=new Date();
      return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate())+'T'+z(d.getHours())+':'+z(d.getMinutes());
    }
    function fillSelect(sel, options){ sel.innerHTML=''; options.forEach(x=>{ const o=document.createElement('option'); o.value=x; o.textContent=x; sel.appendChild(o); }); }
    function requireAlert(missing){
      if(!missing.length) return false;
      alert(t().common.pleaseFill + missing.join(', '));
      return true;
    }

    // ÎŒÎ½Î¿Î¼Î± Ï†Î±ÏÎ¼Î¬ÎºÎ¿Ï… / ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚: Î³ÏÎ¬Î¼Î¼Î±Ï„Î±, Î±ÏÎ¹Î¸Î¼Î¿Î¯, ÎºÎµÎ½Î¬ ÎºÎ±Î¹ Î¼ÎµÏÎ¹ÎºÎ¬ ÏƒÏÎ¼Î²Î¿Î»Î±
    const LETTERS_REGEX = /^[\p{L}\p{N}\s\.\-,()]+$/u;
    function isLettersOnly(v){ return LETTERS_REGEX.test(v); }

    function isIntInRange(v,min,max){ const n=Number(v); return Number.isInteger(n)&&n>=min&&n<=max; }
    function isPressure(v){
      const cleaned = String(v).trim().replace(/[,\s]+/g,'-');
      return /^(\d{1,3})(?:\.\d{1,2})?-(\d{1,3})(?:\.\d{1,2})?$/.test(cleaned);
    }
    function coercePressure(v){
      const cleaned = String(v).trim().replace(/[,\s]+/g,'-');
      const m = cleaned.match(/^(\d{1,3}(?:\.\d{1,2})?)-(\d{1,3}(?:\.\d{1,2})?)$/);
      return m ? (m[1]+'-'+m[2]) : null;
    }
    function isFutureOrNow(dt){ return dt.getTime() >= Date.now(); }

    // print dropdown (ÎºÎ±Î¹ ÏƒÏ„Î¹Ï‚ 2 ÎºÎ±ÏÏ„Î­Î»ÎµÏ‚)
    function rebuildPrintSelect(){
      const ids = ['print-select','print-select2'];
      const items = [
        ['heart',   t().measure.cats.heart],
        ['sugar',   t().measure.cats.sugar],
        ['pressure',t().measure.cats.pressure],
        ['chol',    t().measure.cats.chol]
      ];
      ids.forEach(id=>{
        const sel = document.getElementById(id);
        if(!sel) return;
        const prev = sel.value || 'heart';
        sel.innerHTML = '';
        for (const [val,label] of items){
          const o = document.createElement('option');
          o.value = val; o.textContent = label;
          sel.appendChild(o);
        }
        sel.value = prev;
      });
    }

    // Î®Ï‡Î¿Ï‚ / Î´ÏŒÎ½Î·ÏƒÎ·
    let beepTimer = null;
    function playBeepOnce(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type='sine'; o.frequency.value=900; g.gain.value=0.35;
        o.connect(g).connect(ctx.destination); o.start();
        setTimeout(()=>{try{o.stop(); ctx.close();}catch{}},600);
      }catch{}
    }
    function vibrateOnce(){ try{ if('vibrate' in navigator){ navigator.vibrate([200,200]); } }catch{} }
    function startBeepLoop(){ if(beepTimer) return; playBeepOnce(); vibrateOnce(); beepTimer=setInterval(()=>{playBeepOnce();vibrateOnce();},900); }
    function stopBeepLoop(){ if(beepTimer){ clearInterval(beepTimer); beepTimer=null; } try{ if('vibrate' in navigator) navigator.vibrate(0);}catch{} }

    // modal
    const modalEl = document.getElementById('modal-backdrop');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMsgEl = document.getElementById('modal-message');
    const modalOkEl = document.getElementById('modal-ok');
    const modalSkipEl = document.getElementById('modal-skip');
    const modalSnoozeEl = document.getElementById('modal-snooze');
    let activeModal = null;

    function showModal(title, message, context){
      modalTitleEl.textContent = title;
      modalMsgEl.textContent = message;
      modalEl.style.display = 'flex';
      activeModal = context || null;
      startBeepLoop();

      // system ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· (Î±Î½ Î­Ï‡ÎµÎ¹ Î´Î¿Î¸ÎµÎ¯ Î¬Î´ÎµÎ¹Î±)
      showNativeNotification(title, message);
    }
    function closeModal(){ modalEl.style.display='none'; stopBeepLoop(); activeModal=null; }

    modalOkEl.addEventListener('click', ()=>{
      if(activeModal && activeModal.type==='med'){
        const r = activeModal.item;
        r.lastFireDate = todayStr();
        if(!r.daily){
          const idx = reminders.meds.findIndex(x=>x.id===r.id);
          if(idx>-1) reminders.meds.splice(idx,1);
          renderList('meds');
        }
        persist();
      }
      closeModal();
    });
    modalSkipEl.addEventListener('click', ()=>{
      if(activeModal && activeModal.type==='med'){
        const r = activeModal.item;
        r.lastFireDate = todayStr();
        persist();
      }
      closeModal();
    });
    modalSnoozeEl.addEventListener('click', ()=>{
      if(!activeModal){ closeModal(); return; }
      stopBeepLoop();
      const ctx = activeModal;
      closeModal();
      setTimeout(()=>{
        if(ctx.type==='med'){
          const r = ctx.item;
          showModal(t().reminder_now_title, `${r.name||t().untitled} â€” ${r.time}`, {type:'med', item:r});
        }else if(ctx.type==='appt'){
          const a = ctx.item;
          const when = new Date(a.datetime).toLocaleString(currentLang==='el'?'el-GR':'en-US');
          showModal(t().appt_now_title, `${a.name||t().untitled} â€” ${when}`, {type:'appt', item:a});
        }
      }, 5*60*1000);
    });

    // tabs
    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>s.style.display='none');
      document.getElementById('section-'+id).style.display='block';
    }

    // ===== Reminders (Î¦Î¬ÏÎ¼Î±ÎºÎ± & Î¡Î±Î½Ï„ÎµÎ²Î¿Ï) =====

    function addReminder(type){
      if(type==='meds'){
        const name = document.getElementById('med-name').value.trim();
        const time = document.getElementById('med-time').value;
        const noteSel = document.getElementById('med-note');
        const noteCustom = document.getElementById('med-note-custom').value.trim();
        const needCustom = (noteSel.value==='Î†Î»Î»Î¿â€¦' || noteSel.value==='Otherâ€¦');
        const missing = [];
        if(!name) missing.push(t().meds.name);
        if(!time) missing.push(t().meds.time);
        if(needCustom && !noteCustom) missing.push(t().meds.noteLabel);
        if(requireAlert(missing)) return;

        if(!isLettersOnly(name)) return alert(t().errors.bad_text);
        if(needCustom && noteCustom && !isLettersOnly(noteCustom)) return alert(t().errors.bad_text);

        const noteVal = needCustom ? noteCustom : (noteSel.value==='â€”' ? '' : noteSel.value);
        const daily = document.getElementById('med-daily').checked;
        const item = { id:Date.now(), name, time, daily, lastFireDate:null, note: noteVal||'' };
        reminders.meds.push(item);
        persist(); renderList('meds');

        document.getElementById('med-name').value = '';
        document.getElementById('med-time').value = '';
        document.getElementById('med-daily').checked = false;
        noteSel.selectedIndex = 0;
        document.getElementById('med-note-custom').value=''; document.getElementById('med-note-custom').style.display='none';
      }else{
        const name = document.getElementById('appt-name').value.trim();
        const datetime = document.getElementById('appt-datetime').value;
        const missing = [];
        if(!name) missing.push(t().appts.name);
        if(!datetime) missing.push(t().appts.datetime);
        if(requireAlert(missing)) return;

        if(!isLettersOnly(name)) return alert(t().errors.bad_text);

        const dt = new Date(datetime);
        if(!isFutureOrNow(dt)){
          setApptMinNow();
          return alert(currentLang==='el' ? 'Î— Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±/ÏÏÎ± Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿ Ï€Î±ÏÎµÎ»Î¸ÏŒÎ½.' : 'Date/time cannot be in the past.');
        }

        const item = { id:Date.now(), name, datetime:dt.toISOString(), notified:false };
        reminders.appts.push(item);
        persist(); renderList('appts');

        document.getElementById('appt-name').value = '';
        document.getElementById('appt-datetime').value = '';
      }
    }

    function setApptMinNow(){
      const el = document.getElementById('appt-datetime');
      const nowVal = nowLocalDatetimeValue();
      el.min = nowVal;
      if(el.value && el.value < nowVal){ el.value = nowVal; }
    }
    document.getElementById('appt-datetime').addEventListener('focus', setApptMinNow);
    document.getElementById('appt-datetime').addEventListener('click', setApptMinNow);
    setApptMinNow();

    function renderList(type){
      const list = document.getElementById('list-'+type); list.innerHTML='';
      reminders[type].forEach(r=>{
        const div = document.createElement('div'); div.className='item';
        let left='';
        if(type==='meds'){
          left = `<div><div class="title">${r.name||t().untitled}</div><div class="sub">${t().meds.list_time(r.time, r.daily, r.note||'')}</div></div>`;
        } else {
          const apptDate = new Date(r.datetime);
          const notifyAt = new Date(apptDate.getTime() - 3*60*60*1000);
          const dtStr = apptDate.toLocaleString(currentLang==='el'?'el-GR':'en-US');
          const notifStr = notifyAt.toLocaleString(currentLang==='el'?'el-GR':'en-US');
          left = `<div><div class="title">${r.name||t().untitled}</div><div class="sub">${t().appts.list_line(dtStr, notifStr)}</div></div>`;
        }
        const actions = document.createElement('div'); actions.className='actions';
        const del = document.createElement('button'); del.className='btn'; del.textContent=t().common.del; del.onclick=()=>deleteReminder(type,r.id);
        actions.appendChild(del); div.innerHTML=left; div.appendChild(actions); list.appendChild(div);
      });
      applyCollapsible(list, 2);
    }

    function deleteReminder(type,id){
      if(!confirm(t().common.confirmDel)) return;
      const arr = reminders[type]; const idx = arr.findIndex(x=>x.id===id);
      if(idx>-1){
        arr.splice(idx,1);
        persist(); renderList(type);
      }
    }

    // ===== ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï =====
    setInterval(()=>{
      checkAppointmentsForDueNotifications();
    }, 30000);

    function checkAppointmentsForDueNotifications(){
      const now = Date.now();
      reminders.appts.forEach(a=>{
        const apptTime = new Date(a.datetime);
        const notifyTime = new Date(apptTime.getTime() - 3*60*60*1000);
        if(!a.notified && now >= notifyTime.getTime()){
          const when = apptTime.toLocaleString(currentLang==='el'?'el-GR':'en-US');
          showModal(t().appt_now_title, `${a.name||t().untitled} â€” ${when}`, {type:'appt', item:a});
          a.notified = true;
        }
      });
      persist();
    }

    // ===== Î¦Î¬ÏÎ¼Î±ÎºÎ±: tick ÎºÎ¬Î¸Îµ 30" =====
    setInterval(()=>{
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const cur = hh+':'+mm;
      const today = todayStr();
      reminders.meds.slice().forEach(r=>{
        if(r.time === cur){
          if(r.lastFireDate === today) return;
          showModal(t().reminder_now_title, `${r.name||t().untitled} â€” ${cur}`, {type:'med', item:r});
        }
      });
    }, 30000);

    // ===== ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚ =====
    let currentMeasure = null;

    function updateMeasureNoteOptions(kind){
      const sel = document.getElementById('measure-note');
      const opts = t().measure.noteOptions[kind] || ['â€”','Î†Î»Î»Î¿â€¦'];
      fillSelect(sel, opts);
      document.getElementById('measure-note-custom').placeholder = (currentLang==='el'?'Î†Î»Î»Î¿â€¦':'Otherâ€¦');
    }

    function unitFor(kind){ return (kind==='heart') ? 'bpm' : (kind==='chol' ? '% SpOâ‚‚' : ''); }

    function updateMeasureInputsForCurrent(){
      const input = document.getElementById('measure-value');
      const hint  = document.getElementById('measure-hint');
      if(!currentMeasure){
        input.type='number'; input.placeholder='';
        document.getElementById('label-measure-value').textContent = t().measure.value;
        hint.textContent='';
        return;
      }
      if(currentMeasure==='pressure'){
        input.type='text';
        input.placeholder = t().measure.placeholders.pressure;
        document.getElementById('label-measure-value').textContent = t().measure.pressureLabel;
        hint.textContent = t().measure.pressureHint;
      } else if(currentMeasure==='heart'){
        input.type='number'; input.step='1'; input.min='20'; input.max='220';
        input.placeholder = t().measure.placeholders.heart;
        document.getElementById('label-measure-value').textContent = `${t().measure.value} (${unitFor('heart')})`;
        hint.textContent = t().measure.pulseHint;
      } else if(currentMeasure==='chol'){
        input.type='number'; input.step='1'; input.min='50'; input.max='100';
        input.placeholder = t().measure.placeholders.chol;
        document.getElementById('label-measure-value').textContent = `${t().measure.value} (${unitFor('chol')})`;
        hint.textContent = t().measure.oxygenHint;
      } else { // sugar
        input.type='number'; input.step='1'; input.min='40'; input.max='600';
        input.placeholder = t().measure.placeholders.sugar;
        document.getElementById('label-measure-value').textContent = t().measure.value;
        hint.textContent = '';
      }
    }

    function openMeasure(kind){
      currentMeasure = kind;
      document.getElementById('measure-form').style.display='block';
      document.getElementById('measure-title').innerText =
        (currentLang==='el'?'ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·: ':'Entry: ') + t().measure.entryTitle(kind);

      updateMeasureInputsForCurrent();
      updateMeasureNoteOptions(kind);

      document.getElementById('measure-note-custom').value='';
      document.getElementById('measure-note-custom').style.display='none';
      document.getElementById('measure-note').onchange = (e)=>{
        const v = e.target.value;
        const isCustom = (v==='Î†Î»Î»Î¿â€¦' || v==='Otherâ€¦');
        document.getElementById('measure-note-custom').style.display = isCustom ? 'block' : 'none';
      };
    }

    function saveMeasure(){
      const input = document.getElementById('measure-value');
      let raw = String(input.value).trim();

      const noteSel = document.getElementById('measure-note');
      const needCustom = (noteSel.value==='Î†Î»Î»Î¿â€¦' || noteSel.value==='Otherâ€¦');
      const noteCustom = document.getElementById('measure-note-custom').value.trim();
      const missing = [];
      if(!raw) missing.push(t().measure.value);
      if(needCustom && !noteCustom) missing.push(t().measure.noteLabel);
      if(requireAlert(missing)) return;

      if(needCustom && noteCustom && !isLettersOnly(noteCustom)) return alert(t().errors.bad_text);

      let val = raw;
      if(currentMeasure==='pressure'){
        if(!isPressure(raw)) return alert(t().errors.bad_pressure);
        val = coercePressure(raw);
      } else if(currentMeasure==='heart'){
        if(!isIntInRange(raw,20,220)) return alert(t().errors.bad_pulse);
        val = Number(raw) + ' ' + unitFor('heart');
      } else if(currentMeasure==='chol'){
        if(!isIntInRange(raw,50,100)) return alert(t().errors.bad_oxygen);
        val = Number(raw) + ' ' + unitFor('chol');
      } else {
        if(!isIntInRange(raw,40,600)) return alert(currentLang==='el'?'Î¤Î¿ Î¶Î¬Ï‡Î±ÏÎ¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 40â€“600.':'Glycemia must be 40â€“600.');
        val = Number(raw);
      }

      const noteVal = needCustom ? noteCustom : (noteSel.value==='â€”' ? '' : noteSel.value);

      const now = new Date();
      const date = now.toLocaleDateString(currentLang==='el'?'el-GR':'en-US');
      const time = now.toLocaleTimeString(currentLang==='el'?'el-GR':'en-US',{hour:'2-digit',minute:'2-digit'});

      if(!measures[currentMeasure]) measures[currentMeasure]=[];
      measures[currentMeasure].push({date,time,value:val, note:noteVal||''});
      persist(); renderMeasures();

      input.value=''; input.placeholder='';
      document.getElementById('label-measure-value').textContent = t().measure.value;
      document.getElementById('measure-hint').textContent='';
      updateMeasureNoteOptions(currentMeasure);
      document.getElementById('measure-note-custom').value='';
      document.getElementById('measure-note-custom').style.display='none';
    }

    function renderMeasures(){
      const list = document.getElementById('measure-list'); list.innerHTML='';
      for(const kind in measures){
        const title = t().measure.entryTitle(kind);
        measures[kind].forEach((m, idx)=>{
          const div = document.createElement('div'); div.className='item';
          div.innerHTML = `<div><div class="title">${title}</div><div class="sub">${t().measure.entry(m.date,m.time,m.value,m.note||'')}</div></div>`;
          const actions = document.createElement('div'); actions.className='actions';
          const delBtn = document.createElement('button');
          delBtn.className='btn'; delBtn.textContent = t().common.del;
          delBtn.onclick = ()=>{
            if(confirm(t().common.confirmDel)){
              measures[kind].splice(idx,1);
              persist(); renderMeasures();
            }
          };
          actions.appendChild(delBtn);
          div.appendChild(actions);
          list.appendChild(div);
        });
      }
      applyCollapsible(list, 2);
    }

    // print
    function printSelected(){ printSelectedFrom('print-select'); }
    function printSelectedFrom(selId){
      const sel = document.getElementById(selId);
      if(!sel) return;
      printMeasures(sel.value);
    }
    function printMeasures(kind){
      const data = measures[kind] || [];
      const title = t().measure.entryTitle(kind);
      const w = window.open('', '_blank');
      const thDate = currentLang==='el'?'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±':'Date';
      const thTime = currentLang==='el'?'ÎÏÎ±':'Time';
      const thValue= currentLang==='el'?'Î¤Î¹Î¼Î®':'Value';
      const thNote = currentLang==='el'?'Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·':'Note';
      const style = `
        <style>
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto; padding:20px}
          h1{margin:0 0 10px 0; font-size:20px}
          table{border-collapse:collapse; width:100%}
          th,td{border:1px solid #999; padding:8px; text-align:left}
          th{background:#eee}
        </style>`;
      const rows = data.map(d=>`<tr><td>${d.date}</td><td>${d.time}</td><td>${d.value}</td><td>${d.note||''}</td></tr>`).join('') || `<tr><td colspan="4">-</td></tr>`;
      w.document.write(`
        <html><head><title>${title}</title>${style}</head>
        <body>
          <h1>${title}</h1>
          <table>
            <thead><tr><th>${thDate}</th><th>${thTime}</th><th>${thValue}</th><th>${thNote}</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <script>window.onload=()=>window.print();<\/script>
        </body></html>`);
      w.document.close();
    }

    // collapsible
    function applyCollapsible(listEl, threshold=2){
      listEl.querySelectorAll('.collapsible-extra, .collapse-toggle').forEach(n=>n.remove());
      const items = Array.from(listEl.children).filter(n=>n.classList.contains('item'));
      if(items.length <= threshold) return;

      const extra = document.createElement('div');
      extra.className = 'collapsible-extra';
      for(let i=threshold;i<items.length;i++){ extra.appendChild(items[i]); }

      const btn = document.createElement('button');
      btn.className = 'collapse-toggle';
      const updText = (open)=>{
        const n = extra.children.length;
        btn.textContent = open ? t().common.less : `${t().common.more} (${n})`;
      };
      updText(false);
      btn.addEventListener('click', ()=>{
        const open = extra.style.display !== 'none';
        extra.style.display = open ? 'none' : 'block';
        updText(!open);
      });

      listEl.appendChild(btn);
      listEl.appendChild(extra);
      extra.style.display = 'none';
    }

    // setLang
    function setLang(lang){
      if(!i18n[lang]) return;
      currentLang = lang; localStorage.setItem(STORAGE_LANG, lang);

      // tabs
      document.getElementById('tab-meds').textContent     = t().tabs.meds;
      document.getElementById('tab-appts').textContent    = t().tabs.appts;
      document.getElementById('tab-measure').textContent  = t().tabs.measure;
      document.getElementById('tab-prints').textContent   = t().tabs.prints;

      // meds
      document.getElementById('meds-title').textContent = t().meds.title;
      document.getElementById('meds-lead').textContent  = t().meds.lead;
      document.getElementById('label-med-name').textContent = t().meds.name;
      document.getElementById('label-med-time').textContent = t().meds.time;
      document.getElementById('label-med-note').textContent = t().meds.noteLabel;
      document.getElementById('label-med-daily').textContent= t().meds.daily;
      document.getElementById('btn-add-meds').textContent  = t().meds.add;
      fillSelect(document.getElementById('med-note'), t().meds.noteOptions);
      document.getElementById('med-note-custom').placeholder = (lang==='el'?'Î†Î»Î»Î¿â€¦':'Otherâ€¦');

      // appts
      document.getElementById('appts-title').textContent  = t().appts.title;
      document.getElementById('appts-lead').textContent   = t().appts.lead;
      document.getElementById('label-appt-name').textContent = t().appts.name;
      document.getElementById('label-appt-datetime').textContent = t().appts.datetime;
      document.getElementById('btn-add-appt').textContent  = t().appts.add;
      setApptMinNow();

      // measure
      document.getElementById('measure-title-main').textContent = t().measure.title;
      document.getElementById('measure-lead').textContent = t().measure.lead;
      document.getElementById('btn-heart').textContent    = t().measure.cats.heart;
      document.getElementById('btn-sugar').textContent    = t().measure.cats.sugar;
      document.getElementById('btn-pressure').textContent = t().measure.cats.pressure;
      document.getElementById('btn-chol').textContent     = t().measure.cats.chol;
      document.getElementById('label-measure-note').textContent = t().measure.noteLabel;
      document.getElementById('btn-save-measure').textContent   = t().measure.save;

      // Î•ÎºÏ„Ï…Ï€ÏÏƒÎµÎ¹Ï‚
      document.getElementById('label-print').textContent = t().measure.printLabel;
      document.getElementById('btn-print').textContent   = t().measure.printBtn;
      document.getElementById('prints-title').textContent = t().prints.title;
      document.getElementById('prints-lead').textContent  = t().prints.lead;
      document.getElementById('label-print2').textContent = t().prints.label;
      document.getElementById('btn-print2').textContent   = t().prints.btn;

      rebuildPrintSelect();
      updateMeasureInputsForCurrent();

      // modal
      document.getElementById('modal-title').textContent = t().modal.reminder;
      document.getElementById('modal-ok').textContent    = t().modal.ok;
      document.getElementById('modal-skip').textContent  = t().modal.skip;
      document.getElementById('modal-snooze').textContent= t().modal.snooze5;

      renderAll();
      document.documentElement.lang = (lang==='el'?'el':'en');
    }

    document.getElementById('med-note').addEventListener('change', (e)=>{
      const isCustom = (e.target.value==='Î†Î»Î»Î¿â€¦' || e.target.value==='Otherâ€¦');
      document.getElementById('med-note-custom').style.display = isCustom ? 'block' : 'none';
    });

    function renderAll(){ renderList('meds'); renderList('appts'); renderMeasures(); }

    // SPLASH fade-out
    window.addEventListener('load', ()=>{
      const s = document.getElementById('splash');
      if(!s) return;
      setTimeout(()=>{
        s.classList.add('hidden');
        setTimeout(()=>{ if(s && s.parentNode){ s.parentNode.removeChild(s); } }, 700);
      }, 1500);
    });

    // ---- Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ----
    setLang(currentLang);
    checkAppointmentsForDueNotifications(); // Î³Î¹Î± ÏÎ±Î½Ï„ÎµÎ²Î¿Ï Ï€Î¿Ï… "Ï‡Î¬Î¸Î·ÎºÎ±Î½" ÏŒÏƒÎ¿ Î®Ï„Î±Î½ ÎºÎ»ÎµÎ¹ÏƒÏ„ÏŒÏ‚ Î¿ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚
  </script>
</body>
</html>
